// ==UserScript==
// @name         Bgm.tv auto tracker
// @namespace    https://trim21.me/
// @description  auto tracker your bangumi progress
// @version      0.4.0
// @author       Trim21
// @match        https://www.bilibili.com/bangumi/play/*
// @match        https://bangumi-auto-tracker.trim21.cn/oauth_callback*
// @match        https://bangumi-auto-tracker.trim21.cn/userscript/options*
// @require      https://cdn.bootcss.com/axios/0.18.0/axios.js
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_openInTab
// @grant        GM_addStyle
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @connect      localhost
// @connect      api.bgm.tv
// @connect      bangumi-auto-tracker.trim21.cn
// @run-at       document-end
// ==/UserScript==

!function(){"use strict";let t=unsafeWindow,e=GM_xmlhttpRequest,i=GM_setValue,r=GM_getValue,a=GM_openInTab,o=GM_addStyle;console.log("hello world");let n=t.jQuery;function s(t){let e=new Date;n("#bgm_tv_tracker_notification").prepend(`<hr><p>${e.getHours()}:${e.getMinutes()}:${e.getSeconds()} ${t}</p>`)}n||console.log("no jquery in this page");const c=function(t){let e={},i=/^([^: \t]+):[ \t]*((?:.*[^ \t])|)/.exec(t),r=i&&i[1];return e[r=r.toLowerCase()]=i[2],e},l=(t,e)=>i=>{i.headers=function(t){let e={};for(let i of t.trim().split("\r"))(i=i.trim())&&Object.assign(e,c(i));return e}(i.responseHeaders),i.status<300?(i.headers["content-type"].startsWith("application/json")&&(i.data=JSON.parse(i.responseText)),t(i)):(console.log(i),i.headers["content-type"].startsWith("application/json")&&(i.data=JSON.parse(i.responseText)),e({response:i}))},_={get:(t,i={})=>new Promise((r,a)=>{e({method:"GET",url:t,headers:i,onload:l(r,a)})}),post:(t,i={},r={})=>(null!==i&&"object"==typeof i&&(i=JSON.stringify(i),r["content-Type"]="application/json"),new Promise((a,o)=>{e({method:"POST",data:i,url:t,headers:r,onload:l(a,o)})}))},d={get:(t,e={})=>new Promise((i,r)=>{_.get(t,e).then(t=>{if(401===t.data.code){r({response:t})}else i(t)},t=>r(t))}),post:(t,e={},i={})=>new Promise((r,a)=>{_.post(t,e,i).then(t=>{r(t)},t=>a(t))})},p={apiServerURL:"https://bangumi-auto-tracker.trim21.cn",callBackUrl:"https://bangumi-auto-tracker.trim21.cn/oauth_callback",apiBgmUrl:"https://api.bgm.tv",authURL:""};p.authURL="https://bgm.tv/oauth/authorize?client_id=bgm2775b2797b4d958b&response_type=code&redirect_uri="+p.callBackUrl,"dev"===window.TM_ENV&&(p.apiServerURL="http://localhost:6001",console.log("dev"));let g,b=r("collection",!1);function m(t){b[t]||_.post(`${p.apiBgmUrl}/collection/${t}/update`,"status=do",{"content-type":"application/x-www-form-urlencoded",Authorization:"Bearer "+g.access_token}).then(e=>{401===e.data.code?s(e.data.error):(s("add this bangumi to your collection"),b[t]=!0,i("collection",JSON.stringify(b)))},t=>s(t.response.data.error_description))}function u(t){var e;m(t.subject_id),(e=t.subject_id,new Promise((t,a)=>{let o=r(`eps_${e}`,!1);o?(o=JSON.parse(o),Number((new Date).getTime()/1e3)-o.time>7200?_.get(`${p.apiBgmUrl}/subject/${e}/ep`).then(r=>{r.data.time=Number((new Date).getTime()/1e3),i(`eps_${e}`,JSON.stringify(r.data)),t(r.data)},t=>{a(t),s("get bgm eps error")}):t(o)):d.get(`${p.apiBgmUrl}/subject/${e}/ep`).then(r=>{r.data.time=Number((new Date).getTime()/1e3),i(`eps_${e}`,JSON.stringify(r.data)),t(r.data)},t=>{a(t),s("get bgm eps error")})})).then(e=>{let i=e.eps[parseInt(t.episode)-1].id;_.post(`${p.apiBgmUrl}/ep/${i}/status/watched`,null,{Authorization:"Bearer "+g.access_token}).then(()=>s("mark your status successfully".toString()),t=>s(JSON.stringify(t.response.data)))},t=>s(JSON.stringify(t.response.data))).catch(function(t){s(t.toString())})}if(b=b?JSON.parse(b):{},t.location.href.startsWith(p.callBackUrl)){if(t.data){i("auth",JSON.stringify(t.data));let e=t.document.createElement("h1");e.innerText="成功授权 请关闭网页",t.document.body.appendChild(e)}}else if(g=r("auth",!1))g=JSON.parse(g);else{t.alert("you need to auth bgm.tv_auto_tracker first")&&a(p.authURL,{active:!0})}if(t.location.href.startsWith("https://www.bilibili.com/bangumi/play/")){console.log("inject bilibili"),function(){const e=t.__INITIAL_STATE__,i=e.epInfo.index,r=e.mediaInfo.season_id;n("#bangumi_detail > div > div.info-right > div.info-title.clearfix > div.func-module.clearfix").prepend('<div id="bgm_tv_tracker" class="disable" data-id=""><div class="bgm_tv_tracker_btn bgm_tv_tracker bgm_tv_tracker_radius">bgm.tv</div><div class="bgm_tv_tracker_info"><br><div><p>你正在看: <span id="bgm_tv_tracker_title"></span></p><p>第 <span id="bgm_tv_tracker_episode">{episode}</span>集</p></div><br><div id="bgm_tv_tracker_link"></div><br><button class="bgm_tv_tracker_radius" id="bgm_tv_tracker_mark_watch">标记本集为看过</button> <button class="bgm_tv_tracker_radius" id="bgm_tv_tracker_mark_watched">看到本集</button><br><br><a href="https://github.com/Trim21/bilibili-bangumi-tv-auto-tracker/issues" target="_blank" rel="noopener noreferrer">报告问题</a><br><div id="bgm_tv_tracker_notification"></div></div></div>'),n("#bgm_tv_tracker_episode").html(i),n("#bgm_tv_tracker").data("id",r),o("#bgm_tv_tracker{display:inline-block;position:relative;float:left;margin-right:20px;user-select:none}.bgm_tv_tracker_radius{border-radius:4px;border:1px solid #e5e9ef}.bgm_tv_tracker_btn.bgm_tv_tracker{color:#6d757a;float:left;cursor:pointer;font-size:14px;height:28px;line-height:28px;text-align:center;width:80px!important;transition:all .1s ease-in}.bangumi-info .info-right .info-title.clearfix h2{width:380px}@media screen and (max-width:1400px){.arc-toolbar .block{padding:0 12px;margin-left:-12px}.video-toolbar-module .btn-item{padding:0 0 0 60px!important;margin-left:-12px}.bangumi-info .info-right .info-title.clearfix h2{width:200px!important}}#bgm_tv_tracker.disable .bgm_tv_tracker_info{display:none}.bgm_tv_tracker_info{padding:8px;margin-top:5px;background:#fff;border-radius:0 0 4px 4px;border:1px solid #e5e9ef;box-shadow:rgba(0,0,0,.16) 0 2px 4px;cursor:default;height:auto;left:-1px;line-height:normal;opacity:0;pointer-events:none;position:absolute;text-align:left;top:70px;white-space:normal;width:300px;z-index:1000}.bgm_tv_tracker_info *{max-width:100%}#bgm_tv_tracker .bgm_tv_tracker_info{opacity:1;pointer-events:auto;top:100%}.bgm_tv_tracker_info button{padding:4px 6px;line-height:14px;display:inline-block;margin:4px}");let a=n(".bgm_tv_tracker_info");n(".bgm_tv_tracker_btn.bgm_tv_tracker").click(()=>{a.toggle("fast")}).hover(function(){n(this).css("background-color","#00A1D6"),n(this).css("color","white")},function(){n(this).css("background-color","white"),n(this).css("color","black")}),n("#bgm_tv_tracker_title").html(e.mediaInfo.title),_.get(`${p.apiServerURL}/query/bilibili?bangumi_id=${r}`).then(t=>{let e=t.data.bangumi_id||t.data.subject_id;n("#bgm_tv_tracker_link").html(`<a href="http://bgm.tv/subject/${e}" target="_blank" rel="noopener noreferrer">subject/${e}</a>`),n("#bgm_tv_tracker_mark_watched").click(()=>{let t=n("#bgm_tv_tracker_episode").html();m(e),d.post(`https://api.bgm.tv/subject/${e}/update/watched_eps?watched_eps=${t}`,`watched_eps=${t}`,{"content-type":"application/x-www-form-urlencoded",Authorization:"Bearer "+g.access_token}).then(t=>{202===t.data.code?s("mark status successful"):s("error: "+JSON.stringify(t.data))},t=>s("error: "+JSON.stringify(t)))}),n("#bgm_tv_tracker_mark_watch").click(()=>{u({subject_id:e,type:"watch_episode",website:"bilibili",bangumi_id:n("#bgm_tv_tracker").data("id"),title:n("#bgm_tv_tracker_title").html(),episode:n("#bgm_tv_tracker_episode").html()})})},t=>{404===t.response.status&&n(".bgm_tv_tracker_info").html("没找到你在看的番剧")})}();let e=t.__INITIAL_STATE__.epInfo.index;const i=function(){const e=t.__INITIAL_STATE__.epInfo.index;n("#bgm_tv_tracker_episode").html(e)},r=function(){console.log("check href"),e!==t.__INITIAL_STATE__.epInfo.index&&(i(),e=t.__INITIAL_STATE__.epInfo.index)};setInterval(r,1e4),setTimeout(r,2e3)}}();