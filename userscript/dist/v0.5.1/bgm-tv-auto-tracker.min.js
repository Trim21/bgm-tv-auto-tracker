// ==UserScript==
// @name         Bgm.tv auto tracker
// @namespace    https://trim21.me/
// @description  auto tracker your bangumi progress
// @version      0.5.1
// @author       Trim21
// @match        https://www.bilibili.com/bangumi/play/*
// @match        http*://www.iqiyi.com/*
// @match        https://bangumi-auto-tracker.trim21.cn/oauth_callback*
// @match        https://bangumi-auto-tracker.trim21.cn/userscript/options*
// @require      https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js
// @require      https://cdn.bootcss.com/axios/0.18.0/axios.js
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_openInTab
// @grant        GM_addStyle
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @connect      localhost
// @connect      api.bgm.tv
// @connect      bangumi-auto-tracker.trim21.cn
// @run-at       document-end
// ==/UserScript==

!function(){"use strict";let t,e,i=unsafeWindow,a=GM_xmlhttpRequest,r=GM_setValue,n=GM_getValue,o=GM_openInTab,s=GM_addStyle,c=window.$,_={};function l(t){let e=new Date;c("#bgm_tv_tracker_notification").prepend(`<hr><p>${e.getHours()}:${e.getMinutes()}:${e.getSeconds()} ${t}</p>`)}console.log("hello world");const d=function(t){let e={},i=/^([^: \t]+):[ \t]*((?:.*[^ \t])|)/.exec(t),a=i&&i[1];return e[a=a.toLowerCase()]=i[2],e},p=(t,e)=>i=>{i.headers=function(t){let e={};for(let i of t.trim().split("\r"))(i=i.trim())&&Object.assign(e,d(i));return e}(i.responseHeaders),i.status<300?(i.headers["content-type"].startsWith("application/json")&&(i.data=JSON.parse(i.responseText)),t(i)):(console.log(i),i.headers["content-type"].startsWith("application/json")&&(i.data=JSON.parse(i.responseText)),e({response:i}))},b={get:(t,e={})=>new Promise((i,r)=>{a({method:"GET",url:t,headers:e,onload:p(i,r)})}),post:(t,e={},i={})=>(null!==e&&"object"==typeof e&&(e=JSON.stringify(e),i["content-Type"]="application/json"),new Promise((r,n)=>{a({method:"POST",data:e,url:t,headers:i,onload:p(r,n)})}))},g={get:(t,e={})=>(Object.assign(e,{"User-Agent":"Bgm.tv auto tracker"}),new Promise((i,a)=>{b.get(t,e).then(t=>{if(t.data.code&&t.data.code>=300){a({response:t})}else i(t)},t=>a(t))})),post:(t,e={},i={})=>(Object.assign(i,{"User-Agent":"Bgm.tv auto tracker"}),new Promise((a,r)=>{b.post(t,e,i).then(t=>{if(t.data.code&&t.data.code>=300){r({response:t})}else a(t)},t=>r(t))}))},m={apiServerURL:"https://bangumi-auto-tracker.trim21.cn",callBackUrl:"https://bangumi-auto-tracker.trim21.cn/oauth_callback",apiBgmUrl:"https://api.bgm.tv",authURL:""};function u(t){return new Promise((e,i)=>{let a=n(`eps_${t}`,!1);a?(a=JSON.parse(a),Number((new Date).getTime()/1e3)-a.time>7200?b.get(`${m.apiBgmUrl}/subject/${t}/ep`).then(i=>{i.data.time=Number((new Date).getTime()/1e3),r(`eps_${t}`,JSON.stringify(i.data)),e(i.data)},t=>{i(t),l("get bgm eps error")}):e(a)):g.get(`${m.apiBgmUrl}/subject/${t}/ep`).then(i=>{i.data.time=Number((new Date).getTime()/1e3),r(`eps_${t}`,JSON.stringify(i.data)),e(i.data)},t=>{i(t),l("get bgm eps error")})})}m.authURL="https://bgm.tv/oauth/authorize?client_id=bgm2775b2797b4d958b&response_type=code&redirect_uri="+m.callBackUrl,"dev"===window.TM_ENV&&(m.apiServerURL="http://localhost:6001",console.log("dev"));let f=n("collection",!1);function v(t){f[t]||b.post(`${m.apiBgmUrl}/collection/${t}/update`,"status=do",{"content-type":"application/x-www-form-urlencoded",Authorization:"Bearer "+e.access_token}).then(e=>{401===e.data.code?l(e.data.error):(l("add this bangumi to your collection"),f[t]=!0,r("collection",JSON.stringify(f)))},t=>l(t.response.data.error_description))}if(f=f?JSON.parse(f):{},i.location.href.startsWith(m.callBackUrl)){if(i.data){r("auth",JSON.stringify(i.data));let t=i.document.createElement("h1");t.innerText="成功授权 请关闭网页",i.document.body.appendChild(t)}}else if(e=n("auth",!1))e=JSON.parse(e);else{i.alert("you need to auth bgm.tv_auto_tracker first")&&o(m.authURL,{active:!0})}const h=function(t){var i;_.subjectID=t,c("#bgm_tv_tracker_link").html(`<a href="http://bgm.tv/subject/${t}" target="_blank" rel="noopener noreferrer">subject/${t}</a>`),c("#bgm_tv_tracker_mark_watched").click(()=>{let i=c("#bgm_tv_tracker_episode").html();v(t),u(t).then(a=>{let r=a.eps.findIndex(function(t){return t.sort===parseInt(i)})+1;g.post(`https://api.bgm.tv/subject/${t}/update/watched_eps?watched_eps=${r}`,`watched_eps=${r}`,{"content-type":"application/x-www-form-urlencoded",Authorization:"Bearer "+e.access_token}).then(t=>{202===t.data.code?l("mark status successful"):l("error: "+JSON.stringify(t.data))},t=>l("error: "+JSON.stringify(t)))})}),c("#bgm_tv_tracker_mark_watch").click(()=>{v((i={subject_id:t,type:"watch_episode",website:"bilibili",bangumi_id:c("#bgm_tv_tracker").data("id"),title:c("#bgm_tv_tracker_title").html(),episode:c("#bgm_tv_tracker_episode").html()}).subject_id),u(i.subject_id).then(t=>{console.log(i.episode);let a=t.eps.filter(function(t){return t.sort===parseInt(i.episode)});console.log(a),a=a[0].id,b.post(`${m.apiBgmUrl}/ep/${a}/status/watched`,null,{Authorization:"Bearer "+e.access_token}).then(()=>l("mark your status successfully".toString()),t=>l(JSON.stringify(t.response.data)))},t=>l(JSON.stringify(t.response.data))).catch(function(t){l(t.toString())})})};if(i.location.href.startsWith("https://www.bilibili.com/bangumi/play/")){console.log("inject bilibili"),t="bilibili",function(){const t=i.__INITIAL_STATE__,e=t.epInfo.index,a=t.mediaInfo.season_id;_.bangumiID=t.mediaInfo.season_id,_.episode=e,c("#bangumi_detail > div > div.info-right > div.info-title.clearfix > div.func-module.clearfix").prepend('<div id="bgm_tv_tracker" class="disable" data-id=""><div class="bgm_tv_tracker_btn bgm_tv_tracker bgm_tv_tracker_radius">bgm.tv</div><div class="bgm_tv_tracker_info"><div class="not_found"></div><br><div><p>你正在看: <span id="bgm_tv_tracker_title"></span></p><p>第 <span id="bgm_tv_tracker_episode">{episode}</span>集</p></div><br><div id="bgm_tv_tracker_link"></div><br><button class="bgm_tv_tracker_radius" id="bgm_tv_tracker_mark_watch">标记本集为看过</button> <button class="bgm_tv_tracker_radius" id="bgm_tv_tracker_mark_watched">看到本集</button><br><br><a href="https://github.com/Trim21/bilibili-bangumi-tv-auto-tracker/issues" target="_blank" rel="noopener noreferrer">报告问题</a><br><div id="bgm_tv_tracker_notification"></div></div></div>'),s("#bgm_tv_tracker{display:inline-block;position:relative;float:left;margin-right:20px;user-select:none}.bgm_tv_tracker_radius{border-radius:4px;border:1px solid #e5e9ef}.bgm_tv_tracker_btn.bgm_tv_tracker{color:#6d757a;float:left;cursor:pointer;font-size:14px;height:28px;line-height:28px;text-align:center;width:80px!important;transition:all .1s ease-in}#bangumi_detail .bangumi-info.clearfix .info-right .info-title.clearfix a h2{width:380px}@media screen and (max-width:1400px){.arc-toolbar .block{padding:0 12px;margin-left:-12px}.video-toolbar-module .btn-item{padding:0 0 0 60px!important;margin-left:-12px}#bangumi_detail .bangumi-info.clearfix .info-right .info-title.clearfix a h2{width:200px!important}}#bgm_tv_tracker.disable .bgm_tv_tracker_info{display:none}.bgm_tv_tracker_info{padding:8px;margin-top:5px;background:#fff;border-radius:0 0 4px 4px;border:1px solid #e5e9ef;box-shadow:rgba(0,0,0,.16) 0 2px 4px;cursor:default;height:auto;left:-1px;line-height:normal;opacity:0;pointer-events:none;position:absolute;text-align:left;top:70px;white-space:normal;width:300px;z-index:1000}.bgm_tv_tracker_info *{max-width:100%}#bgm_tv_tracker .bgm_tv_tracker_info{opacity:1;pointer-events:auto;top:100%}.bgm_tv_tracker_info button{padding:4px 6px;line-height:14px;display:inline-block;margin:4px;border:2px solid #fff}.bgm_tv_tracker_info button:active{background:#fff}.bgm_tv_tracker_info button:hover{border:2px solid #99bdf7}");let r=c(".bgm_tv_tracker_info");c(".bgm_tv_tracker_btn.bgm_tv_tracker").click(()=>{r.toggle("fast")}).hover(function(){c(this).css("background-color","#00A1D6"),c(this).css("color","white")},function(){c(this).css("background-color","white"),c(this).css("color","black")}),c("#bgm_tv_tracker_episode").html(e),c("#bgm_tv_tracker").data("id",a),c("#bgm_tv_tracker_title").html(t.mediaInfo.title),b.get(`${m.apiServerURL}/query/bilibili?bangumi_id=${a}`).then(t=>{let e=t.data.bangumi_id||t.data.subject_id;h(e)},t=>{if(404===t.response.status){let t=c(".bgm_tv_tracker_info .not_found").html('<label><input type="text" class="subject"> <button class="notfound">submit subject id</button></label>');c(".bgm_tv_tracker_info .not_found button").click(()=>{let e=c(".bgm_tv_tracker_info .not_found input").val();e&&(t.hide(),b.get(`${m.apiServerURL}/api/v0.1/missingBilibili?bangumi_id=${a}&subject_id=${e}`),h(e))})}})}();let e=i.__INITIAL_STATE__.epInfo.index;const a=function(){const t=i.__INITIAL_STATE__,e=t.epInfo.index;_.bangumiID=t.mediaInfo.season_id,_.episode=e,c("#bgm_tv_tracker_episode").html(e)},r=function(){console.log("check href"),e!==i.__INITIAL_STATE__.epInfo.index&&(a(),e=i.__INITIAL_STATE__.epInfo.index)};setInterval(r,1e4),setTimeout(r,5e3)}if("www.iqiyi.com"===i.location.hostname){let e;console.log(i.Q.PageInfo.playPageInfo.categoryName),t="iqiyi";let a=i.document.title;const r=function(){console.log("inject iqiyi just for collecting animation data now");let t=c("#datainfo-navlist > a:nth-child(3)").html();c("#jujiPlayWrap > div:nth-child(2) > div > div > div.funcRight.funcRight1014").prepend('<div id="bgm_tv_tracker" class="disable" data-id=""><div class="bgm_tv_tracker_btn bgm_tv_tracker bgm_tv_tracker_radius">bgm.tv</div><div class="bgm_tv_tracker_info"><div class="not_found"></div><br><div><p>你正在看: <span id="bgm_tv_tracker_title"></span></p><p>第 <span id="bgm_tv_tracker_episode">{episode}</span>集</p></div><br><div id="bgm_tv_tracker_link"></div><br><button class="bgm_tv_tracker_radius" id="bgm_tv_tracker_mark_watch">标记本集为看过</button> <button class="bgm_tv_tracker_radius" id="bgm_tv_tracker_mark_watched">看到本集</button><br><br><a href="https://github.com/Trim21/bilibili-bangumi-tv-auto-tracker/issues" target="_blank" rel="noopener noreferrer">报告问题</a><br><div id="bgm_tv_tracker_notification"></div></div></div>'),s("#bgm_tv_tracker{margin-left:15px;padding-left:16px;position:relative;font-size:15px;float:left;cursor:pointer;display:inline;user-select:none}.bgm_tv_tracker_btn.bgm_tv_tracker{float:left;cursor:pointer;font-size:14px;height:28px;line-height:18px;text-align:center;width:80px!important;transition:all .1s ease-in}#bgm_tv_tracker.disable .bgm_tv_tracker_info{display:none}.bgm_tv_tracker_info{padding:8px;margin-top:5px;background:#fff;border:1px solid #e5e9ef;cursor:default;height:auto;left:-1px;line-height:normal;opacity:0;pointer-events:none;position:absolute;text-align:left;top:70px;white-space:normal;width:300px;z-index:1000}.bgm_tv_tracker_info *{max-width:100%}#bgm_tv_tracker .bgm_tv_tracker_info{opacity:1;pointer-events:auto;top:100%}.bgm_tv_tracker_info button{padding:4px 6px;line-height:14px;display:inline-block;margin:4px}");let e=c(".bgm_tv_tracker_info");c(".bgm_tv_tracker_btn.bgm_tv_tracker").click(()=>{e.toggle("fast")}).hover(function(){c(this).css("color","#5aa700")},function(){c(this).css("color","#959799")}),console.log(t),a=i.document.title,b.post(`${m.apiServerURL}/api/v0.1/parser/title`,{title:t,title_with_episode:a}).then(e=>{c("#bgm_tv_tracker_title").html(t),c("#bgm_tv_tracker_episode").html(e.data.episode),c("#bgm_tv_tracker").data("id",e.data.bangumi_id);let a=e.data.subject_id||e.data.bangumi_id;if(_.subjectID=a,a)h(a);else{let t=c(".bgm_tv_tracker_info .not_found").html('<label><input type="text" class="subject"> <button class="notfound">submit subject id</button></label>');c(".bgm_tv_tracker_info .not_found button").click(()=>{let e=c(".bgm_tv_tracker_info .not_found input").val();e&&(t.hide(),b.get(`${m.apiServerURL}/api/v0.1/missingBilibili?bangumi_id=${encodeURI(i.location.href)}&subject_id=${e}`),h(e))})}},()=>{l("net work error")})},n=function(){console.log("hash change"),e!==i._player._videoid&&a!==i.document.title||(console.log("video not change"),setTimeout(n,500)),e=i._player._videoid,a=i.document.title};"动漫"===i.Q.PageInfo.playPageInfo.categoryName&&(setTimeout(r,1e3),i.addEventListener("hashchange",function(){setTimeout(n,500)},!1))}}();