<template>
  <div id="bgm_tv_tracker" class="disable"
       :class="{iqiyi:this.website==='iqiyi', bilibili:this.website==='bilibili'}">
    <div class="bgm_tv_tracker_btn bgm_tv_tracker bgm_tv_tracker_radius" @click="trigger">bgm.tv{{ score }}</div>
    <div class="bgm_tv_tracker_info">
      <div class="not_found" v-if="!subjectID">
        <label>
          <input type="text" class="subject" v-model="tmpSubjectID"/>
          <button class="notfound" @click="userSubmitSubjectID()">submit subject id</button>
        </label>
      </div>
      <br>
      <div>
        <p>你正在看:
          <span id="bgm_tv_tracker_title">{{ bangumiName }}</span>
        </p>
        <p>第 <span id="bgm_tv_tracker_episode">{{ episode }}</span> 集</p>
        <p>Bangumi ID: {{ bangumiID }}</p>
        <p>本集观看进度: {{ watchPercent.toString().substr(0, 4) }}%</p>
      </div>
      <br>
      <div id="bgm_tv_tracker_link">
        <a :href="`https://bgm.tv/subject/${subjectID}`" target="_blank"
           rel="noopener noreferrer">subject/{{ subjectID }}</a>
      </div>
      <br>
      <button class="bgm_tv_tracker_radius" id="bgm_tv_tracker_mark_watch" @click="watchEps">标记本集为看过</button>
      <button class="bgm_tv_tracker_radius" id="bgm_tv_tracker_mark_watched" @click="setWatchProgress">看到本集</button>
      <br>
      <br>
      <a href="https://github.com/Trim21/bilibili-bangumi-tv-auto-tracker/issues" target='_blank'
         rel="noopener noreferrer">报告问题</a>
      <br>
      <div id="bgm_tv_tracker_notification">
        <div v-for="(message, index) in messages" :key="index">
          <hr>
          <div><p>
            {{ message.time.getHours() }}:{{ message.time.getMinutes() }}:{{ message.time.getSeconds() }}
          </p>
            <pre><code>{{ message.text }}</code></pre>
          </div>
        </div>
      </div>
      <!--<button class="bgm_tv_tracker_radius" id="bgm_tv_tracker_config">config</button>-->
      <label>
        播放进度大于80%时自动标记为看过
        <input type="checkbox" style="-webkit-appearance:checkbox" v-model="config.autoMarkWatched">
      </label>
    </div>
  </div>
</template>
<script>
import $ from 'jquery'
import { gmGetValue, gmSetValue, gmUnsafeWindow, WEBSITE } from './vars'
import { apiServer } from './utils'

/**
 * @type {Object}
 */
let collection = gmGetValue('collection', false)

if (!collection) {
  collection = {}
} else {
  collection = JSON.parse(collection)
}

export default {
  data () {
    let website = ''
    if (gmUnsafeWindow.location.href.startsWith('https://www.bilibili.com/bangumi/play/')) {
      website = WEBSITE.bilibili
    }
    else if (gmUnsafeWindow.location.hostname === 'www.iqiyi.com') {
      website = WEBSITE.iqiyi
    }
    let config = gmGetValue('config', false)
    if (config) {
      config = JSON.parse(config)
    }
    return {
      tmpSubjectID: null,
      messages: [],
      bangumiID: null,
      bangumiName: null,
      // is episode starts with 1, like https://www.bilibili.com/bangumi/play/ep200167
      episodeStartWith: null,
      episode: null,
      title: null,
      subjectID: null,
      score: '',
      config: {
        autoMarkWatched: config.autoMarkWatched,
      },
      watchPercent: 0,
      episodeMarked: false,
      website
    }
  },
  watch: {
    config: {
      handler (val, oldVal) {
        // this.notify(JSON.stringify(val, null, 2))
        console.log(val)
        gmSetValue('config', JSON.stringify(val))
      },
      deep: true
    },
    subjectID (val) {
      this.episodeMarked = false
      let vm = this
      if (val)
        this.$bgmApi.getSubject(val).then(response => {
          vm.score = ' ' + response.data.rating.score
          vm.bangumiName = response.data.name_cn || response.data.name
        })
    },
    episode () {
      this.episodeMarked = false
    }
  },
  methods: {
    userSubmitSubjectID () {
      this.subjectID = this.tmpSubjectID
      let subjectID = this.tmpSubjectID
      if (subjectID) {
        apiServer.get('/api/v0.1/missingBilibili',
          { params: { bangumi_id: bangumiID, subject_id: subjectID } })
      }
    },

    /**
     * Append a message to banner
     * @param {string} message.
     */
    notify (message) {
      let now = new Date()
      this.messages.unshift({
        time: now,
        text: message,
      })
      console.log(this.messages)
    },

    collectSubject (subjectID) {
      let vm = this
      if (!collection[subjectID]) {
        this.$bgmApi.setSubjectCollectionStatus({ subjectID, status: 'do' }).then(
          response => {
            if (response.data.code === 401) {
              vm.notify(JSON.stringify(response))
              vm.notify(response.data.error)
            } else {
              vm.notify('add this bangumi to your collection')
              collection[subjectID] = true
              gmSetValue('collection', JSON.stringify(collection))
            }
          },
          error => vm.notify(error.response.data.error_description)
        )
      }
    },

    trigger () {
      $('.bgm_tv_tracker_info').toggle('fast')
    },
    watchEps () {
      let vm = this
      this.collectSubject(this.subjectID)
      vm.$bgmApi.getEps(this.subjectID).then(
        data => {
          let episode = vm.episode - vm.episodeStartWith + 1
          let eps = data.eps.filter(val => Number.isInteger(Number(val.sort)))

          eps = eps.sort(function (a, b) {
            let key = 'sort'
            var x = a[key]
            var y = b[key]
            return ((x < y) ? -1 : ((x > y) ? 1 : 0))
          })

          try {
            let ep = eps[episode - 1].id
            vm.$bgmApi.setEpisodeWatched(ep)
            vm.notify('mark your status successfully')
          } catch (e) {
            vm.notify(e.toString())
          }

        },
        error => {
          vm.notify('233')
          vm.notify(JSON.stringify(error))
        })
      // .catch(reason => vm.notify(JSON.stringify(reason)))

    },
    setWatchProgress () {
      let episode = this.episode - this.episodeStartWith + 1
      this.collectSubject(this.subjectID)
      this.$bgmApi.setSubjectProgress(this.subjectID, episode).then(
        () => this.notify('mark status successful'),
        error => {
          if (error.response.data.code === 400) {
            this.notify('error: ' + error.response.data.error + ',' + '应该是因为你在bgm上的状态已经是看到本集')
          } else {
            this.notify('error: ' + JSON.stringify(error.response))
          }
        }
      )
    }
  },
  created () {
    // episode-item
    this.$website.init().then(data => {
      console.log(data)
      let { subjectID, episode, title, bangumiID, episodeStartWith } = data
      this.subjectID = subjectID
      this.episode = episode
      this.title = title
      this.bangumiID = bangumiID
      this.episodeStartWith = episodeStartWith
    }, error => {
      console.log(error)
      if (error.error.response.status === 404) {
        this.notify('番剧没找到 手动输入吧')
      }
      let { episode, title, bangumiID, episodeStartWith } = error
      this.episodeStartWith = episodeStartWith
      this.episode = episode
      this.title = title
      this.bangumiID = bangumiID
    })

    let vm = this
    this.$website.detectEpisodeChange(data => {
        if (data.subjectID)
          vm.subjectID = data.subjectID
        if (data.episode)
          vm.episode = data.episode
        if (data.bangumiID)
          vm.bangumiID = data.bangumiID
      },
      error => {
        console.log(error)
        vm.episode = error.episode
        if (error.bangumiID !== vm.bangumiID) {
          if (!error.subjectID) {
            this.subjectID = undefined
          }
          vm.bangumiID = error.bangumiID
        }
      })

    this.$bgmApi.http.interceptors.request.use(function (config) {
      //在发送请求之前做某事
      if (gmUnsafeWindow.bgm_tv_debug || window.bgm_tv_debug) {
        vm.notify('config: ' + JSON.stringify(config, null, 2))
      }
      return config
    }, function (error) {
      //请求错误时做些事
      if (gmUnsafeWindow.bgm_tv_debug || window.bgm_tv_debug) {
        vm.notify('response: ' + JSON.stringify(response, null, 2))
      }
      return Promise.reject(error)
    })

    this.$bgmApi.http.interceptors.response.use(function (response) {
      //对响应数据做些事
      if (gmUnsafeWindow.bgm_tv_debug || window.bgm_tv_debug) {
        vm.notify('response: ' + JSON.stringify(response, null, 2))
      }
      return response
    }, function (error) {
      //请求错误时做些事
      if (gmUnsafeWindow.bgm_tv_debug || window.bgm_tv_debug) {
        vm.notify('error: ' + JSON.stringify(error, null, 2))
      }
      return Promise.reject(error)
    })
    setInterval(() => {
      this.$website.getPlayerTime().then(percent => {
        console.log('get player percent')
        this.watchPercent = percent
        if (percent > 0.8) {
          if (this.config.autoMarkWatched && !this.episodeMarked) {
            this.episodeMarked = true
            this.watchEps()
          }
        }
      })
    }, 5 * 1000)
  }
}

</script>
<style lang="scss">
  #bgm_tv_tracker.disable .bgm_tv_tracker_info {
    display: none;
  }

  @import "../style/scss/iqiyi";
  @import "../style/scss/bilibili";
</style>
